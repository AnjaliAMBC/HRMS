@model HRMS.Models.TicketingModel


@Html.Partial("_NavBar")
<div class="container-fluid res-admin-Ticketing">
    <div class="hiddenadmindashboard" style="display: none"></div>
    @Html.Partial("_adminsidemenu")
    <div class="main-content container-fluid AdminItTicketing-View" style="width: 84%">

        <div class="content admin-it-ticketing-container" style="margin-left: -25px; margin-top: 20px;">
            <div class="container-fluid res-admin-it-ticket-listing">
                <div class="row mb-2 align-items-center">
                    <div class="col-lg-3 col-md-6 admin-it-ticketing-title">
                        <h3 class="ml-1">IT Ticketing</h3>
                    </div>

                    <div class="col-lg-4 navbarl1 col-sm-12 col-md-12 res-admin-empman-search">
                        <div class="search-container" style=" margin-left: 32px; ">
                            <div class="input-group" style="border-radius: 20px;">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" style="background-color: transparent; border-right: none; border-radius: 20px 0 0 20px; height: 35px;"><i class="fas fa-search" style="color: #369479"></i></span>
                                </div>
                                <input type="text" placeholder="Search By Keyword" class="advancesearch it-search form-control" aria-label="Search By Keyword" style="border-radius: 0 20px 20px 0; height: 35px; font-size: 14px;">
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-5 res-admin-it-ticketlisting-header-right">
                        <!-- Filters -->
                        <div class="col-lg-12 col-sm-7 col-md-5 res-admin-it-ticketlisting-block-header res-admin-it-ticketlisting-filter">
                            <div class="admin-it-ticketlisting-filtertab d-flex align-items-center">
                                <p class="advancetitle mb-0">Filters</p>
                                <div class="toggle-button admin-it-ticketlisting-button ml-2">
                                    <button class="collapsedropdown collapsed btn" type="button" data-toggle="collapse" data-target="#adminitticketlistingfilter" aria-expanded="false" aria-controls="demo">
                                        <i class="fa-solid fa-angle-down"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="row justify-content-end ml-2 col-md-12 res-admin-it-ticketlisting-filter-show">
                    <div class="col-lg-12 col-sm-12 col-md-12">
                        <div id="adminitticketlistingfilter" class="collapse adminiticketlistingfilter">
                            <div class="collapse-topic align-items-center justify-content-end res-admin-it-ticketlisting-filter-inside" style="margin-right: 0; display: flex;">
                                <span class="mr-3 res-admin-filter">
                                    Filter By<span class="res-close-btn" style="display:none;">X</span>
                                </span>
                                <div class="form-group res-adminadvfilter-itticketlisting d-flex">
                                    <label for="from" class="mr-2">From Date</label>
                                    <input type="date" class="form-control form-control-sm mr-2" id="itticketlisting-fromDate" style="width: 120px;">
                                </div>
                                <div class="form-group res-adminadvfilter-itticketlisting d-flex">
                                    <label for="from" class="mr-2">To Date</label>
                                    <input type="date" class="form-control form-control-sm mr-2" id="itticketlisting-toDate" style="width: 120px;">
                                </div>
                                <div class="dropdown res-adminadvfilter-itticketlisting">
                                    <select class="form-control form-select-sm" name="status" id="it-ticketlisting-status-dropdown" style="border-radius: 15px; height: 28px; width: 131px; border: 1px solid lightgray; padding: 0 10px; font-size: 12px;">
                                        <option value="" disabled selected>Status</option>
                                        <option value="Approved">Approved</option>
                                        <option value="Rejected">Rejected</option>
                                        <option value="Pending">Pending</option>
                                        <option value="Cancelled">Cancelled</option>
                                        <option value="All">All</option>
                                    </select>
                                </div>
                                <div class="dropdown res-adminadvfilter-itticketlisting">
                                    <select class="form-control form-select-sm" name="location" id="it-ticketlisting-location-dropdown" style="border-radius: 15px; height: 28px; width: 131px; border: 1px solid lightgray; padding: 0 10px; font-size: 12px;">
                                        <option value="" disabled selected>Location</option>
                                        <option value="Madurai">Madurai</option>
                                        <option value="Hyderabad">Hyderabad</option>
                                        <option value="All">All</option>
                                    </select>
                                </div>
                                <div class="dropdown res-adminadvfilter-itticketlisting">
                                    <select class="form-control form-select-sm" name="closedby" id="it-ticketlisting-closedby-dropdown" style="border-radius: 15px; height: 28px; width: 131px; border: 1px solid lightgray; padding: 0 10px; font-size: 12px;">
                                        <option value="" disabled selected>Closed By</option>
                                        <option value="Raj">Raj</option>
                                        <option value="Kumar">Kumar</option>
                                    </select>
                                </div>
                                <div class="form-group align-items-center res-adminadvfilter-itticketlisting mr-2">
                                    <button type="button" class="btn btn-sm btn-primary itticketlisting-view">View</button>
                                    <button type="button" class="btn btn-sm btn-primary itticketlisting-export">Export</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="res-admin-it-ticket-listing-table table-responsive">
                    <table class="table table-admin-it-ticket-listing" id="adminitticketlistingTable" style="font-size:14px;">
                        <thead style="background-color: #EEF4FF; border-radius: 10px;display:none;">
                            <tr>
                                <th>Emp-ID</th>
                                <th>Priority</th>
                                <th>Location</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var ticket in Model.empTickets)
                            {
                                <tr>
                                    <td style="width: 400px">
                                        <div class="res-admin-it-ticketlisting-user-details" style="display: flex; align-items: center;">
                                            <i class="it-ticket-msg-icon fa-regular fa-message"></i>
                                            <span style="margin-top: 0px; margin-right: 10px;">
                                                <div class="admin-it-ticketing-listing-title">@ticket.Subject</div>
                                                <div class="admin-it-ticketing-listing-details">
                                                    <span class="it-ticket-id">#@ticket.TicketNo</span>
                                                    <span class="it-ticket-info"><i class="fa-solid fa-folder" aria-hidden="true"></i> @ticket.Category</span>
                                                    <span class="id-name">@ticket.EmployeeID @ticket.EmployeeName</span>
                                                </div>
                                            </span>
                                        </div>
                                    </td>
                                    <td style="width: 400px" class="res-admin-it-ticketlisting-priority">
                                        <div style="visibility: hidden;" class="it-ticketing-response-time">
                                            Response Time @ticket.ResponseTime Hr
                                        </div>
                                        <div class="it-ticketing-priority-date">
                                            <span class="it-ticket-prioritylevel">
                                                <span class="res-it-ticketlisting-color res-it-ticketlisting-color-red"></span>
                                                <span class="res-it-ticketlisting-priority-status">@ticket.Priority</span>
                                            </span>
                                            <span class="res-admin-it-ticketlisting-date">
                                                <i class="fa-solid fa-clock" aria-hidden="true"></i>
                                                <span class="res-itticketlisting-priority-status">
                                                    @(ticket.Created_date.HasValue ? ticket.Created_date.Value.ToString("dd MMM yyyy, ddd hh:mmtt") : "N/A")
                                                </span>

                                            </span>
                                        </div>
                                    </td>
                                    <td class="res-admin-itticketlisting-location-info">
                                        <div class="it-ticketing-empty-block"></div>
                                        <div class="res-itticketlisting-location">@ticket.Location</div>
                                    </td>
                                    <td class="res-admin-itticketlisting-status">
                                        <div class="it-ticketing-empty-block"></div>
                                        <div class="res-itticketlisting-status-level ticket-status-@ticket.Status" onclick="adminitticketcommentpopup($(this))">@ticket.Status</div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

            </div>
        </div>

    </div>

</div>

<!-- admin it ticket comments Modal -->
<div id="adminItTicketCommentsModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="adminItTicketCommentsModal" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body">

                <div class="modal-header">
                    <h5 class="modal-title" id="adminItTicketConfirmCancelModalLabel">Comments</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="admin-it-ticketing-commentbox-popup-list">
                    <div class="admin-it-ticketing-commentbox-list">
                        <div class="col-lg-1 admin-it-ticketing-commentbox-left">
                            <img class="userIcon" src="/Assets/EmpImages/1075.jpeg">
                            <div class="vl"></div>
                        </div>
                        <span class="col-lg-7 admin-it-ticketing-commentbox-mid">
                            <div class="admin-it-ticketing-commentbox-userinfo">1155 Sriram</div>
                            <div class="admin-it-ticketing-commentbox-status">Ticket Reopen</div>
                            <div class="admin-it-ticketing-commentbox-desc" title="This is dummy text This is dummy text This is dummy text This is dummy text">This is dummy text This is dummy text This is dummy text This is dummy text</div>
                        </span>
                        <span class="col-lg-2 admin-it-ticketing-commentbox-right">
                            <div class="admin-it-ticketing-commentbox-date">03 July 2024</div>
                        </span>
                    </div>

                    <div class="admin-it-ticketing-commentbox-list">
                        <div class="col-lg-1 admin-it-ticketing-commentbox-left">
                            <img class="userIcon" src="/Assets/EmpImages/1020.jpeg">
                            <div class="vl"></div>
                        </div>
                        <span class="col-lg-7 admin-it-ticketing-commentbox-mid">
                            <div class="admin-it-ticketing-commentbox-userinfo">1155 Sriram</div>
                            <div class="admin-it-ticketing-commentbox-status">Ticket Closed</div>
                        </span>
                        <span class="col-lg-2 admin-it-ticketing-commentbox-right">
                            <div class="admin-it-ticketing-commentbox-date">03 July 2024</div>
                        </span>
                    </div>

                    <div class="admin-it-ticketing-commentbox-list">
                        <div class="col-lg-1 admin-it-ticketing-commentbox-left">
                            <img class="userIcon" src="/Assets/EmpImages/1075.jpeg">
                        </div>
                        <span class="col-lg-7 admin-it-ticketing-commentbox-mid">
                            <div class="admin-it-ticketing-commentbox-userinfo">1155 Sriram</div>
                            <div class="admin-it-ticketing-commentbox-status">Ticket Acknowledge</div>
                            <div class="admin-it-ticketing-commentbox-desc" title="This is dummy text This is dummy text This is dummy text This is dummy text">This is dummy text This is dummy text This is dummy text This is dummy text</div>
                        </span>
                        <span class="col-lg-2 admin-it-ticketing-commentbox-right">
                            <div class="admin-it-ticketing-commentbox-date">03 July 2024</div>
                        </span>
                    </div>

                </div>


            </div>
        </div>
    </div>
</div>


<script>
    $(document).ready(function () {
        if (!$.fn.DataTable.isDataTable('#table-admin-it-ticket-listing')) {
            $('#table-admin-it-ticket-listing').DataTable({
                "paging": true,
                "searching": true,
                "ordering": false,
                "info": true,
                "autoWidth": false,
                "lengthMenu": [[7, 14, 21, -1], [7, 14, 21, "All"]],
                "columnDefs": [
                    { "orderable": false, "targets": [1, 3] } // Adjusted to array form for multiple targets
                ]
            });
        }
    });
    // It ticketing search

    $(document).on('keyup', '.it-search', function () {
        var searchText = $(this).val().toLowerCase();
        $('#adminitticketlistingTable tbody tr').each(function () {
            var found = false;
            $(this).find('td').each(function () {
                var cellContent = $(this).text().toLowerCase();
                if (cellContent.indexOf(searchText) !== -1) {
                    found = true;
                    return false; // Exit loop if found
                }
            });

            if (found) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });


    $(document).on('click', '.itticketlisting-export', function (event) {
        event.preventDefault();
        var fromDate = $('#itticketlisting-fromDate').val();
        var toDate = $('#itticketlisting-toDate').val();
        var status = $('#it-ticketlisting-status-dropdown').val();
        var location = $('#it-ticketlisting-location-dropdown').val();
        var closedBy = $('#it-ticketlisting-closedby-dropdown').val();

        // Clear previous validation messages
        $('.validation-error').remove();
        $('#itticketlisting-fromDate').removeClass('is-invalid');
        $('#itticketlisting-toDate').removeClass('is-invalid');

        // Check if the dates are provided
        var isValid = true;
        if (!fromDate) {
            $('#itticketlisting-fromDate').addClass('is-invalid');
            $('#itticketlisting-fromDate').closest('.form-group').append('<span class="validation-error text-danger">From date is required</span>');
            isValid = false;
        }
        if (!toDate) {
            $('#itticketlisting-toDate').addClass('is-invalid');
            $('#itticketlisting-toDate').closest('.form-group').append('<span class="validation-error text-danger">To date is required</span>');
            isValid = false;
        }

        // If both dates are provided, proceed with the export
        if (isValid) {
            $('.show-progress').show();
            window.location.href = "/adminticketing/itexportoexcel?fromDate=" + fromDate + "&toDate=" + toDate + "&status=" + status + "&location=" + location + "&closedBy=" + closedBy;
            $('.show-progress').hide();
        }
    });

    function adminitticketcommentpopup(currentthis) {
        var ticketName = currentthis.attr("data-ticketname");

        // Show the confirmation modal
        $('#adminItTicketCommentsModal').modal('show');
    }


</script>

